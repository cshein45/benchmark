# Reusable workflow for building all binaries
# This workflow is called by other workflows to build reth, geth, builder, op-program, and contracts
name: Build Binaries

on:
  workflow_call:
    inputs:
      optimism_version:
        description: "Optimism version to build"
        required: false
        type: string
        default: "3019251e80aa248e91743addd3e833190acb26f1"
      geth_version:
        description: "Geth version to build"
        required: false
        type: string
        default: "6cbfcd5161083bcd4052edc3022d9f99c6fe40e0"
      builder_version:
        description: "Builder version to build"
        required: false
        type: string
        default: "23f42c8e78ba3abb45a8840df7037a27e196e601"
      base_reth_node_version:
        description: "Base Reth Node version to build"
        required: false
        type: string
        default: "main"

# Set minimal permissions for all jobs by default
permissions:
  contents: read

jobs:
  build-contracts:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required for artifact upload
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@82dee4ba654bd2146511f85f0d013af94670c4de # v1.4.0
      - name: Cache Forge artifacts
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        with:
          path: |
            contracts/out
            contracts/cache
          key: ${{ runner.os }}-forge-${{ hashFiles('**/foundry.toml', '**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-forge-

      - name: Build Contracts
        run: |
          forge build --force

      - name: Upload contract artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: contracts
          path: contracts/out/
          retention-days: 1

  build-reth:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required for artifact upload
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@9399c7bb15d4c7d47b27263d024f0a4978346ba4 # v1.11.0

      - name: Cache reth binary
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        id: cache-optimism
        with:
          path: ~/bin/reth
          key: ${{ runner.os }}-reth-${{ inputs.optimism_version }}

      - name: Build reth
        if: steps.cache-reth.outputs.cache-hit != 'true'
        run: |
          unset CI
          mkdir -p ~/bin
          cd clients
          OPTIMISM_VERSION=${{ inputs.optimism_version }} OUTPUT_DIR=~/bin ./build-reth.sh
          # Rename op-reth to reth for consistency
          [ -f ~/bin/op-reth ] && mv ~/bin/op-reth ~/bin/reth || true

      - name: Upload reth artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: optimism
          path: ~/bin/reth
          retention-days: 1

  build-geth:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required for artifact upload
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0

      - name: Cache geth binary
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        id: cache-geth
        with:
          path: ~/bin/geth
          key: ${{ runner.os }}-geth-${{ inputs.geth_version }}

      - name: Build geth
        if: steps.cache-geth.outputs.cache-hit != 'true'
        run: |
          unset CI
          mkdir -p ~/bin
          cd clients
          GETH_VERSION=${{ inputs.geth_version }} OUTPUT_DIR=~/bin ./build-geth.sh

      - name: Upload geth artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: geth
          path: ~/bin/geth
          retention-days: 1

  build-builder:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required for artifact upload
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@9399c7bb15d4c7d47b27263d024f0a4978346ba4 # v1.11.0

      - name: Cache builder binary
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        id: cache-builder
        with:
          path: ~/bin/builder
          key: ${{ runner.os }}-builder-${{ inputs.builder_version }}

      - name: Build builder
        if: steps.cache-builder.outputs.cache-hit != 'true'
        run: |
          unset CI
          mkdir -p ~/bin
          cd clients
          BUILDER_VERSION=${{ inputs.builder_version }} OUTPUT_DIR=~/bin ./build-builder.sh
          # Rename op-rbuilder to builder for consistency
          [ -f ~/bin/op-rbuilder ] && mv ~/bin/op-rbuilder ~/bin/builder || true

      - name: Upload builder artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: builder
          path: ~/bin/builder
          retention-days: 1

  build-base-reth-node:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required for artifact upload
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@9399c7bb15d4c7d47b27263d024f0a4978346ba4 # v1.11.0

      - name: Cache base-reth-node binary
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        id: cache-base-reth-node
        with:
          path: ~/bin/base-reth-node
          key: ${{ runner.os }}-base-reth-node-${{ inputs.base_reth_node_version }}

      - name: Build base-reth-node
        if: steps.cache-base-reth-node.outputs.cache-hit != 'true'
        run: |
          unset CI
          mkdir -p ~/bin
          cd clients
          BASE_RETH_NODE_VERSION=${{ inputs.base_reth_node_version }} OUTPUT_DIR=~/bin ./build-base-reth-node.sh

      - name: Upload base-reth-node artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: base-reth-node
          path: ~/bin/base-reth-node
          retention-days: 1

  build-op-program:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required for artifact upload
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Cache op-program binary
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        id: cache-op-program
        with:
          path: op-program/versions/v1.6.1-rc.1/op-program
          key: ${{ runner.os }}-op-program-${{ hashFiles('op-program/**') }}

      - name: Build op-program
        if: steps.cache-op-program.outputs.cache-hit != 'true'
        run: |
          curl https://mise.run | sh
          pushd op-program
          mise x -- ./build.sh
          popd

      - name: Upload op-program artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: op-program
          path: op-program/versions/v1.6.1-rc.1/op-program
          retention-days: 1
